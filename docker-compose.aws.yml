version: '3.8'

services:
  user-service:
    build:
      context: ./backend-services/user-service
    ports:
      - "8005:8000"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/cloud_learning
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKERS}
    restart: always

  chat-service:
    build:
      context: ./backend-services/chat-service
    ports:
      - "8003:8000"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/cloud_learning
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKERS}
    restart: always

  document-service:
    build:
      context: ./backend-services/document-service
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/cloud_learning
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKERS}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
      - AWS_DEFAULT_REGION=us-east-1
    restart: always

  quiz-service:
    build:
      context: ./backend-services/quiz-service
    ports:
      - "8004:8000"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/cloud_learning
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKERS}
    restart: always

  stt-service:
    build:
      context: ./backend-services/stt-service
    ports:
      - "8002:8000"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/cloud_learning
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKERS}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
      - AWS_DEFAULT_REGION=us-east-1
    restart: always

  tts-service:
    build:
      context: ./backend-services/tts-service
    ports:
      - "8001:8000"
    environment:
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:5432/cloud_learning
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BROKERS}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
      - AWS_DEFAULT_REGION=us-east-1
    restart: always
  # Note: Frontend is served by the separate Nginx EC2 Instance, so we don't run it here usually.
  # However, for simplicity, we can run it here and point the Nginx Load Balancer to it.
  # But the Nginx Load Balancer configuration (nginx-setup.sh) acts as the Reverse Proxy itself.
  # It proxys /api/* to these ports.
  # Content (HTML/JS) needs to be served.
  # The Nginx Load Balancer logic in nginx-setup.sh handles API proxying but logic for serving static files is minimal.
  # Let's assume we deploy backend only here and Frontend logic is handled by Nginx setup or S3 (Phase 3).
