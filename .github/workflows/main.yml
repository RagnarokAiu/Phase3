name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY_PREFIX: cloud-learning-platform-dev

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [document-service, tts-service, stt-service, chat-service, quiz-service, user-service]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        cd phase2-services/backend-services/${{ matrix.service }}
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        pip install pytest

    - name: Run Tests
      run: |
        cd phase2-services/backend-services/${{ matrix.service }}
        if [ -d "tests" ]; then pytest tests/ || true; else echo "No tests found for ${{ matrix.service }}"; fi

  build-and-push:
    name: Build and Push Docker Images
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build and Push Backend Images
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        services=("document-service" "tts-service" "stt-service" "chat-service" "quiz-service" "user-service")
        
        for service in "${services[@]}"; do
          echo "Building and pushing $service..."
          cd phase2-services/backend-services/$service
          
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY_PREFIX }}-$service:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/${{ env.ECR_REPOSITORY_PREFIX }}-$service:latest .
          
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY_PREFIX }}-$service:$IMAGE_TAG
          docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY_PREFIX }}-$service:latest
          
          cd "$GITHUB_WORKSPACE"
        done

  deploy:
    name: Deploy to AWS
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Get ECR Login Password
      id: ecr-login
      run: |
        ECR_PASSWORD=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
        echo "::add-mask::$ECR_PASSWORD"
        echo "password=$ECR_PASSWORD" >> $GITHUB_OUTPUT
        echo "registry=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
        ssh-keyscan -H ${{ secrets.NGINX_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Build Frontend
      run: |
        cd phase2-services/frontend-web
        npm install
        npm run build
        tar -czvf frontend-dist.tar.gz -C dist .
        mv frontend-dist.tar.gz $GITHUB_WORKSPACE/

    - name: Create Docker Compose File
      run: |
        cat > docker-compose-template.yml << 'COMPOSE_EOF'
        version: '3.8'
        services:
          document-service:
            image: ECR_REGISTRY_PLACEHOLDER/ECR_PREFIX_PLACEHOLDER-document-service:latest
            ports:
              - "8000:8000"
            environment:
              - DATABASE_URL=postgresql://DB_USER_PLACEHOLDER:DB_PASSWORD_PLACEHOLDER@DB_HOST_PLACEHOLDER:5432/cloud_learning
              - KAFKA_BOOTSTRAP_SERVERS=KAFKA_BROKERS_PLACEHOLDER
            restart: always
          tts-service:
            image: ECR_REGISTRY_PLACEHOLDER/ECR_PREFIX_PLACEHOLDER-tts-service:latest
            ports:
              - "8001:8000"
            environment:
              - DATABASE_URL=postgresql://DB_USER_PLACEHOLDER:DB_PASSWORD_PLACEHOLDER@DB_HOST_PLACEHOLDER:5432/cloud_learning
              - KAFKA_BOOTSTRAP_SERVERS=KAFKA_BROKERS_PLACEHOLDER
            restart: always
          stt-service:
            image: ECR_REGISTRY_PLACEHOLDER/ECR_PREFIX_PLACEHOLDER-stt-service:latest
            ports:
              - "8002:8000"
            environment:
              - DATABASE_URL=postgresql://DB_USER_PLACEHOLDER:DB_PASSWORD_PLACEHOLDER@DB_HOST_PLACEHOLDER:5432/cloud_learning
              - KAFKA_BOOTSTRAP_SERVERS=KAFKA_BROKERS_PLACEHOLDER
            restart: always
          chat-service:
            image: ECR_REGISTRY_PLACEHOLDER/ECR_PREFIX_PLACEHOLDER-chat-service:latest
            ports:
              - "8003:8000"
            environment:
              - DATABASE_URL=postgresql://DB_USER_PLACEHOLDER:DB_PASSWORD_PLACEHOLDER@DB_HOST_PLACEHOLDER:5432/cloud_learning
              - KAFKA_BOOTSTRAP_SERVERS=KAFKA_BROKERS_PLACEHOLDER
            restart: always
          quiz-service:
            image: ECR_REGISTRY_PLACEHOLDER/ECR_PREFIX_PLACEHOLDER-quiz-service:latest
            ports:
              - "8004:8000"
            environment:
              - DATABASE_URL=postgresql://DB_USER_PLACEHOLDER:DB_PASSWORD_PLACEHOLDER@DB_HOST_PLACEHOLDER:5432/cloud_learning
              - KAFKA_BOOTSTRAP_SERVERS=KAFKA_BROKERS_PLACEHOLDER
            restart: always
          user-service:
            image: ECR_REGISTRY_PLACEHOLDER/ECR_PREFIX_PLACEHOLDER-user-service:latest
            ports:
              - "8005:8000"
            environment:
              - DATABASE_URL=postgresql://DB_USER_PLACEHOLDER:DB_PASSWORD_PLACEHOLDER@DB_HOST_PLACEHOLDER:5432/cloud_learning
              - KAFKA_BOOTSTRAP_SERVERS=KAFKA_BROKERS_PLACEHOLDER
            restart: always
        COMPOSE_EOF

    - name: Create Nginx Config File
      run: |
        cat > nginx-config.conf << 'NGINX_EOF'
        upstream document_service {
            server 10.0.10.10:8000;
            server 10.0.11.11:8000;
            server 10.0.10.12:8000;
        }
        upstream tts_service {
            server 10.0.10.10:8001;
            server 10.0.11.11:8001;
            server 10.0.10.12:8001;
        }
        upstream stt_service {
            server 10.0.10.10:8002;
            server 10.0.11.11:8002;
            server 10.0.10.12:8002;
        }
        upstream chat_service {
            server 10.0.10.10:8003;
            server 10.0.11.11:8003;
            server 10.0.10.12:8003;
        }
        upstream quiz_service {
            server 10.0.10.10:8004;
            server 10.0.11.11:8004;
            server 10.0.10.12:8004;
        }
        upstream user_service {
            server 10.0.10.10:8005;
            server 10.0.11.11:8005;
            server 10.0.10.12:8005;
        }
        server {
            listen 80;
            server_name _;
            root /var/www/html;
            index index.html;
            location /api/documents {
                proxy_pass http://document_service;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            location /api/tts {
                proxy_pass http://tts_service;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            location /api/stt {
                proxy_pass http://stt_service;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            location /api/chat {
                proxy_pass http://chat_service;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            location /api/quiz {
                proxy_pass http://quiz_service;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            location /api/users {
                proxy_pass http://user_service;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            location /health {
                return 200 '{"status":"healthy"}';
                add_header Content-Type application/json;
            }
            location / {
                try_files $uri $uri/ /index.html;
            }
        }
        NGINX_EOF

    - name: Deploy Backend Services to App Nodes
      env:
        ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
        ECR_PASSWORD: ${{ steps.ecr-login.outputs.password }}
        ECR_PREFIX: ${{ env.ECR_REPOSITORY_PREFIX }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        KAFKA_BROKERS: ${{ secrets.KAFKA_BROKERS }}
        BASTION_HOST: ${{ secrets.BASTION_HOST }}
        APP_NODE_IPS: ${{ secrets.APP_NODE_IPS }}
      run: |
        # Substitute placeholders in docker-compose template
        sed "s|ECR_REGISTRY_PLACEHOLDER|${ECR_REGISTRY}|g; s|ECR_PREFIX_PLACEHOLDER|${ECR_PREFIX}|g; s|DB_USER_PLACEHOLDER|${DB_USER}|g; s|DB_PASSWORD_PLACEHOLDER|${DB_PASSWORD}|g; s|DB_HOST_PLACEHOLDER|${DB_HOST}|g; s|KAFKA_BROKERS_PLACEHOLDER|${KAFKA_BROKERS}|g" docker-compose-template.yml > docker-compose.yml
        
        for APP_IP in $(echo "$APP_NODE_IPS" | tr ',' ' '); do
          echo "========================================"
          echo "Deploying to App Node: $APP_IP"
          echo "========================================"
          
          # Copy docker-compose file to app node via bastion
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
              -o ProxyCommand="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -W %h:%p ubuntu@${BASTION_HOST}" \
              docker-compose.yml ubuntu@${APP_IP}:/tmp/
          
          # Deploy on app node
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
              -o ProxyCommand="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -W %h:%p ubuntu@${BASTION_HOST}" \
              ubuntu@${APP_IP} << REMOTE_SCRIPT
        echo "${ECR_PASSWORD}" | docker login --username AWS --password-stdin ${ECR_REGISTRY}
        sudo mkdir -p /opt/cloud-platform/services
        sudo chown -R ubuntu:ubuntu /opt/cloud-platform
        cp /tmp/docker-compose.yml /opt/cloud-platform/services/
        cd /opt/cloud-platform/services
        docker compose down --remove-orphans 2>/dev/null || docker-compose down --remove-orphans 2>/dev/null || true
        docker compose pull 2>/dev/null || docker-compose pull
        docker compose up -d 2>/dev/null || docker-compose up -d
        echo "Deployment complete! Containers:"
        docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
        REMOTE_SCRIPT
        done

    - name: Deploy Frontend to Nginx
      env:
        NGINX_HOST: ${{ secrets.NGINX_HOST }}
        BASTION_HOST: ${{ secrets.BASTION_HOST }}
      run: |
        echo "========================================"
        echo "Deploying Frontend to Nginx"
        echo "========================================"
        
        # Copy frontend files via bastion
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -W %h:%p ubuntu@${BASTION_HOST}" \
            frontend-dist.tar.gz ubuntu@${NGINX_HOST}:/tmp/
        
        # Copy nginx config via bastion
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -W %h:%p ubuntu@${BASTION_HOST}" \
            nginx-config.conf ubuntu@${NGINX_HOST}:/tmp/
        
        # Deploy on nginx
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -W %h:%p ubuntu@${BASTION_HOST}" \
            ubuntu@${NGINX_HOST} << 'NGINX_SCRIPT'
        sudo mkdir -p /var/www/html
        sudo rm -rf /var/www/html/*
        sudo tar -xzvf /tmp/frontend-dist.tar.gz -C /var/www/html/
        sudo chown -R www-data:www-data /var/www/html
        sudo cp /tmp/nginx-config.conf /etc/nginx/sites-available/cloud-platform
        sudo ln -sf /etc/nginx/sites-available/cloud-platform /etc/nginx/sites-enabled/
        sudo rm -f /etc/nginx/sites-enabled/default
        sudo nginx -t && sudo systemctl reload nginx
        rm /tmp/frontend-dist.tar.gz /tmp/nginx-config.conf
        echo "Frontend deployment complete!"
        NGINX_SCRIPT

    - name: Deployment Summary
      run: |
        echo "========================================"
        echo "âœ… DEPLOYMENT COMPLETE!"
        echo "========================================"
        echo ""
        echo "Backend Services: document(8000), tts(8001), stt(8002), chat(8003), quiz(8004), user(8005)"
        echo "App Nodes: ${{ secrets.APP_NODE_IPS }}"
        echo "Frontend: Deployed to Nginx"
        echo ""
        echo "ðŸŒ Access: http://${{ secrets.NGINX_HOST }}"
#